{% extends "base.html" %}
{% block content %}
<h2>Sites Map</h2>
<div id="map" style="height: 72vh; border: 1px solid #ccc; border-radius: 6px;"></div>
{% endblock %}

{% block extra_scripts %}
<script>
  var map = L.map('map').setView([39.73, -121.84], 9);

  // MapTiler DEMO Satellite and Streets
  const satellite = L.tileLayer(
    'https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=Get_Your_Own_Consumer_Key',
    {
      tileSize: 512,
      zoomOffset: -1,
      minZoom: 0,
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
    }
  );

  const streets = L.tileLayer(
    'https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=Get_Your_Own_Consumer_Key',
    {
      tileSize: 512,
      zoomOffset: -1,
      minZoom: 0,
      maxZoom: 20,
      attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a>'
    }
  );

  satellite.addTo(map);
  L.control.layers({"Satellite": satellite, "Streets": streets}, {}).addTo(map);

  const sites = {{ sites|tojson }};
  sites.forEach(s => {
    let jobsHtml = "";
    if (s.jobs && s.jobs.length) {
      jobsHtml = "<ul style='margin:6px 0 0 16px;'>";
      s.jobs.forEach(j => {
        jobsHtml += `<li><a href="/jobs/${j.id}">${j.job_number} (${j.category})</a></li>`;
      });
      jobsHtml += "</ul>";
    } else {
      jobsHtml = "<div style='color:#666'>No jobs yet</div>";
    }
    const html = `<b>${s.name}</b><br/>Customer: ${s.customer}<br/>
                  <a href="/sites/${s.id}">Open site page</a>
                  ${jobsHtml}`;
    L.marker([s.lat, s.lng]).addTo(map).bindPopup(html);
  });
</script>
{% endblock %}
